---
title: 微信常见功能
tag:
  - 项目总结
date: 2023-11-28
category:
  - 开发日志
  - 微信
---

## 1.重定向落地页获取 code

```vue
<script>
import querystring from 'querystring'
export default {
  methods(){
    // 查询协议+域名
		getRedirectUri() {
			let href = window.location.href
			let search = window.location.search
			return href.replace(search, '')
		}
    redirectWx(){
      	const redirect_uri = this.getRedirectUri()
        let params = {
          appid: '', //微信公众号id
          // redirect_uri: encodeURIComponent(redirect_uri),
          redirect_uri: redirect_uri,
          response_type: 'code',
          scope: 'snsapi_userinfo',
          state:'', //自定义参数
          forcePopup: true,
          forceSnapShot: true
        }
        params = querystring.stringify(params)
        this.redirectWxUrl = `${wxUrl}?${params}#wechat_redirect`
        window.location.href = this.redirectWxUrl
    },
   	// 监听浏览器刷新
		addEvents() {
			let eventName = 'beforeunload'
			const { gecko, iPhone, iPad } = this.getBrowserVersion()
			if (gecko) {
				eventName = 'unload'
			}
			if (iPhone || iPad) {
				eventName = 'pagehide'
			}
			window.addEventListener(eventName, this.handlerClosePage)
		},
		removeEvents() {
			let eventName = 'beforeunload'
			const { gecko, iPhone, iPad } = this.getBrowserVersion()
			if (gecko) {
				eventName = 'unload'
			}
			if (iPhone || iPad) {
				eventName = 'pagehide'
			}
			window.removeEventListener(eventName, this.handlerClosePage)
		},
		handlerClosePage() {
			const state = unit.getUrlParam('state')
			const pay = unit.getUrlParam('pay')
			const path = this.$route.path
			if (state && pay === 'sucess' && path === '/wx-surmax-policy') {
				this.closePage()
			}
		},
		// 打开微信公众号主页
		openOfficialAccount() {
				const [appId] = (unit.getUrlParam('state') || '').split(',')
			let biz = mwEnum.appidMap[appId]
			if (!biz || !appId) {
				this.$toast('系统异常,请联系管理员')
				return false
			}
			let params = {
				action: 'home',
				__biz: biz
			}
			params = querystring.stringify(params)
			const url = `https://mp.weixin.qq.com/mp/profile_ext?${params}#wechat_redirect`
			location.replace(url)
		},
    // 重定向url
		redirectUrl(url) {
			if (window.history && window.history.replaceState) {
				window.history.replaceState(null, document.title, url)
				window.history.go(0)
			} else {
				window.location.replace(url)
			}
		},
		// 关闭当前页面
		closePage() {
			const { weixin } = this.getBrowserVersion()
			if (weixin && window.WeixinJSBridge) {
				return window.WeixinJSBridge.call('closeWindow')
			}
			window.close()
		},
		// 浏览器版本
		getBrowserVersion() {
			const u = window.navigator.userAgent
			return {
				trident: u.indexOf('Trident') > -1, //IE内核
				presto: u.indexOf('Presto') > -1, //opera内核
				webKit: u.indexOf('AppleWebKit') > -1, //苹果、谷歌内核
				gecko:
					(u.indexOf('Gecko') > -1 && u.indexOf('KHTML') == -1) ||
					u.indexOf('Firefox') !== -1, //火狐内核
				mobile: !!u.match(/AppleWebKit.*Mobile.*/), //是否为移动终端
				ios: !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/), //ios终端
				android: u.indexOf('Android') > -1 || u.indexOf('Adr') > -1, //android终端
				iPhone: u.indexOf('iPhone') > -1, //是否为iPhone或者QQHD浏览器
				iPad: u.indexOf('iPad') > -1, //是否iPad
				webApp: u.indexOf('Safari') == -1, //是否web应该程序，没有头部与底部
				weixin: u.indexOf('MicroMessenger') > -1, //是否微信 （2015-01-22新增）
				qq: u.match(/\sQQ/i) == ' qq' //是否QQ
			}
		},
    // 初始化页面参数
		setUrlParams(key, value) {
			const url = new URL(window.location)
			const searchParams = new URLSearchParams(url.search)
			searchParams.set(key, value)
			url.search = searchParams.toString()
			window.history.replaceState(null, null, url.toString())
		},
  },
	beforeDestroy() {
		this.removeEvents()
	}
}
</script>
```
