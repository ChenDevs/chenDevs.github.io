import{q as u,g as A,D as K,am as J,E as V,l as Q,aS as Z,as as ee,p as R}from"./app-8KNOzAlN.js";const T={FRONT:"FRONT",BEHIND:"BEHIND"},p={INIT:"INIT",FIXED:"FIXED",DYNAMIC:"DYNAMIC"},L=0;class te{constructor(e,t){this.init(e,t)}init(e,t){this.param=e,this.callUpdate=t,this.sizes=new Map,this.firstRangeTotalSize=0,this.firstRangeAverageSize=0,this.fixedSizeValue=0,this.calcType=p.INIT,this.offset=0,this.direction="",this.range=Object.create(null),e&&this.checkRange(0,e.keeps-1)}destroy(){this.init(null,null)}getRange(){const e=Object.create(null);return e.start=this.range.start,e.end=this.range.end,e.padFront=this.range.padFront,e.padBehind=this.range.padBehind,e}isBehind(){return this.direction===T.BEHIND}isFront(){return this.direction===T.FRONT}getOffset(e){return(e<1?0:this.getIndexOffset(e))+this.param.slotHeaderSize}updateParam(e,t){this.param&&e in this.param&&(e==="uniqueIds"&&this.sizes.forEach((n,o)=>{t.includes(o)||this.sizes.delete(o)}),this.param[e]=t)}saveSize(e,t){this.sizes.set(e,t),this.calcType===p.INIT?(this.fixedSizeValue=t,this.calcType=p.FIXED):this.calcType===p.FIXED&&this.fixedSizeValue!==t&&(this.calcType=p.DYNAMIC,delete this.fixedSizeValue),this.calcType!==p.FIXED&&typeof this.firstRangeTotalSize<"u"&&(this.sizes.size<Math.min(this.param.keeps,this.param.uniqueIds.length)?(this.firstRangeTotalSize=[...this.sizes.values()].reduce((n,o)=>n+o,0),this.firstRangeAverageSize=Math.round(this.firstRangeTotalSize/this.sizes.size)):delete this.firstRangeTotalSize)}handleDataSourcesChange(){let e=this.range.start;this.isFront()?e=e-L:this.isBehind()&&(e=e+L),e=Math.max(e,0),this.updateRange(this.range.start,this.getEndByStart(e))}handleSlotSizeChange(){this.handleDataSourcesChange()}handleScroll(e){this.direction=e<this.offset||e===0?T.FRONT:T.BEHIND,this.offset=e,this.param&&(this.direction===T.FRONT?this.handleFront():this.direction===T.BEHIND&&this.handleBehind())}handleFront(){const e=this.getScrollOvers();if(e>this.range.start)return;const t=Math.max(e-this.param.buffer,0);this.checkRange(t,this.getEndByStart(t))}handleBehind(){const e=this.getScrollOvers();e<this.range.start+this.param.buffer||this.checkRange(e,this.getEndByStart(e))}getScrollOvers(){const e=this.offset-this.param.slotHeaderSize;if(e<=0)return 0;if(this.isFixedType())return Math.floor(e/this.fixedSizeValue);let t=0,n=0,o=0,d=this.param.uniqueIds.length;for(;t<=d;){if(n=t+Math.floor((d-t)/2),o=this.getIndexOffset(n),o===e)return n;o<e?t=n+1:o>e&&(d=n-1)}return t>0?--t:0}getIndexOffset(e){if(!e)return 0;let t=0,n=0;for(let o=0;o<e;o++)n=this.sizes.get(this.param.uniqueIds[o]),t=t+(typeof n=="number"?n:this.getEstimateSize());return t}isFixedType(){return this.calcType===p.FIXED}getLastIndex(){return this.param.uniqueIds.length-1}checkRange(e,t){const n=this.param.keeps;this.param.uniqueIds.length<=n?(e=0,t=this.getLastIndex()):t-e<n-1&&(e=t-n+1),this.range.start!==e&&this.updateRange(e,t)}updateRange(e,t){this.range.start=e,this.range.end=t,this.range.padFront=this.getPadFront(),this.range.padBehind=this.getPadBehind(),this.callUpdate(this.getRange())}getEndByStart(e){const t=e+this.param.keeps-1;return Math.min(t,this.getLastIndex())}getPadFront(){return this.isFixedType()?this.fixedSizeValue*this.range.start:this.getIndexOffset(this.range.start)}getPadBehind(){const e=this.range.end,t=this.getLastIndex();return this.isFixedType()?(t-e)*this.fixedSizeValue:(t-e)*this.getEstimateSize()}getEstimateSize(){return this.isFixedType()?this.fixedSizeValue:this.firstRangeAverageSize||this.param.estimateSize}}const se={dataKey:{type:[String,Function],required:!0},dataSources:{type:Array,required:!0},dataComponent:{type:[Object,Function],required:!0},keeps:{type:Number,default:30},extraProps:{type:Object},estimateSize:{type:Number,default:50},direction:{type:String,default:"vertical"},start:{type:Number,default:0},offset:{type:Number,default:0},topThreshold:{type:Number,default:0},bottomThreshold:{type:Number,default:0},pageMode:{type:Boolean,default:!1},rootTag:{type:String,default:"div"},wrapTag:{type:String,default:"div"},wrapClass:{type:String,default:""},wrapStyle:{type:Object},itemTag:{type:String,default:"div"},itemClass:{type:String,default:""},itemClassAdd:{type:Function},itemStyle:{type:Object},headerTag:{type:String,default:"div"},headerClass:{type:String,default:""},headerStyle:{type:Object},footerTag:{type:String,default:"div"},footerClass:{type:String,default:""},footerStyle:{type:Object},itemScopedSlots:{type:Object}},ie={event:{type:String},uniqueKey:{type:String},tag:{type:String},horizontal:{type:Boolean}},ne=A({setup(i,e){let t=i.horizontal?"offsetWidth":"offsetHeight",n=null;K(()=>{typeof ResizeObserver<"u"&&(n=new ResizeObserver(()=>{d()}),n.observe(e.$el))}),J(()=>{n.observe(e.$el)}),V(()=>{n&&(n.disconnect(),n=null)});const o=()=>e.$el?e.$el[t]:0,d=()=>{const{$parent:r}=e,{uniqueKey:S,event:f}=i;r.$emit(f,S,o())}}}),ae={props:["tag","component","extraProps","index","source","scopedSlots","uniqueKey","slotComponent"],render(){const{tag:i="div",component:e,extraProps:t={},index:n,source:o,scopedSlots:d={},uniqueKey:r,slotComponent:S}=this,f={...t,source:o,index:n};return u(i,{key:r,role:"listitem"},[S?S({item:o,index:n,scope:f}):u(e,{...f,scopedSlots:d})])}},k={mixins:[ne],name:"virtual-list-slot",props:ie,render(){const{tag:i="div",uniqueKey:e,$slots:t}=this;return u(i,{key:e,role:e},t.default)}},m={ITEM:"item_resize",SLOT:"slot_resize"},F={HEADER:"thead",FOOTER:"tfoot"},re=A({name:"virtual-scroll-list",props:se,functional:!0,emits:[m.ITEM,m.SLOT,"resized","scroll","totop","tobottom"],setup(i,e){let t=null,n=i.direction==="horizontal",o=n?"scrollLeft":"scrollTop",d=Q({}),r=null;Z(()=>{z(t.offset),i.pageMode&&document.addEventListener("scroll",E,{passive:!1})}),ee(()=>{i.pageMode&&document.removeEventListener("scroll",E)}),K(()=>{const{header:s,footer:a}=e.$slots||{};(s||a)&&e.emit(m.SLOT,_),i.start?w(i.start):i.offset&&z(i.offset),i.pageMode&&(j(),document.addEventListener("scroll",E,{passive:!1}))}),V(()=>{t.destroy(),i.pageMode&&document.removeEventListener("scroll",E)});const S=s=>{s&&(r=s)},f=()=>i.pageMode?document.documentElement[o]||document.body[o]:r?Math.ceil(r[o]):0,P=()=>{const s=n?"clientWidth":"clientHeight";return i.pageMode?document.documentElement[s]||document.body[s]:r?Math.ceil(r[s]):0},q=()=>{const s=n?"scrollWidth":"scrollHeight";return i.pageMode?document.documentElement[s]||document.body[s]:r?Math.ceil(r[s]):0},z=s=>{i.pageMode?(document.body[o]=s,document.documentElement[o]=s):r&&(r[o]=s)},w=s=>{if(s>=i.dataSources.length-1)$();else{const a=t.getOffset(s);z(a)}},$=()=>{const{shepherd:s}=e.$refs||{};if(s){const a=s[n?"offsetLeft":"offsetTop"];z(a),setTimeout(()=>{f()+P()+1<q()&&$()},3)}},j=()=>{if(r){const s=r.getBoundingClientRect(),{defaultView:a}=r.ownerDocument,l=n?s.left+a.pageXOffset:s.top+a.pageYOffset;t.updateParam("slotHeaderSize",l)}},Y=()=>{t=new te({slotHeaderSize:0,slotFooterSize:0,keeps:i.keeps,estimateSize:i.estimateSize,buffer:Math.round(i.keeps/3),uniqueIds:H()},U),d.value=t.getRange()},H=()=>(i.dataSources||[]).map(s=>typeof i.dataKey=="function"?dataKey(s):s[i.dataKey]),X=(s,a)=>{t.saveSize(s,a),e.emit("resized",s,a)},_=(s,a,l)=>{s===F.HEADER?t.updateParam("slotHeaderSize",a):s===F.FOOTER&&t.updateParam("slotFooterSize",a),l&&t.handleSlotSizeChange()},U=s=>{d.value=s},E=s=>{const a=f(),l=P(),h=q();a<0||a+l>h+1||!h||(t.handleScroll(a),W(a,l,h,s))},W=(s,a,l,h)=>{e.emit("scroll",h,t.getRange()),t.isFront()&&i.dataSources.length&&s-i.topThreshold<=0?e.emit("totop"):t.isBehind()&&s+a+i.bottomThreshold>=l&&e.emit("tobottom")},G=()=>{const s=[],{start:a,end:l}=d.value,{dataSources:h,dataKey:y,itemClass:C,itemTag:b,itemStyle:x,isHorizontal:I,extraProps:M,dataComponent:D,itemScopedSlots:N}=i,{$scopedSlots:O}=e,B=O&&O.item;if(a===void 0||l===void 0)return s;for(let c=a;c<=l;c++){const g=h[c];if(g){const v=typeof y=="function"?y(g):g[y];typeof v=="string"||typeof v=="number"?s.push(u(ae,{index:c,tag:b,event:m.ITEM,horizontal:I,uniqueKey:v,source:g,extraProps:M,component:D,slotComponent:B,scopedSlots:N,style:x,class:`${C}${i.itemClassAdd?" "+i.itemClassAdd(c):""}`})):console.warn(`Cannot get the data-key '${y}' from data-sources.`)}else console.warn(`Cannot get the index '${c}' from data-sources.`)}return s};return R(()=>i.dataSources&&i.dataSources.length,s=>{t.updateParam("uniqueIds",H()),t.handleDataSourcesChange()}),R(()=>i.keep,s=>{t.updateParam("keeps",s),t.handleSlotSizeChange()}),R(()=>i.start,s=>{w(s)}),R(()=>i.offset,s=>{z(s)}),Y(),e.emit(m.ITEM,X),()=>{const{header:s,footer:a}=e.$slots||{},{padFront:l,padBehind:h}=d?d.value||{}:{},{pageMode:y,rootTag:C="div",wrapTag:b="div",wrapClass:x,wrapStyle:I,headerTag:M="div",headerClass:D,headerStyle:N,footerTag:O="div",footerClass:B,footerStyle:c}=i,g={padding:n?`0px ${h}px 0px ${l}px`:`${l}px 0px ${h}px`},v=I?Object.assign({},I,g):g;return u(C,{ref:S,onScroll:!y&&E},[s?u(k,{class:D,style:N,tag:M,event:m.SLOT,uniqueKey:F.HEADER},s):null,u(b,{class:x,role:"group",style:v},G()),a?u(k,{class:B,style:c,tag:O,event:m.SLOT,uniqueKey:F.FOOTER},a):null,u("div",{ref:"shepherd",style:{width:n?"0px":"100%",height:n?"100%":"0px"}})])}}});export{re as default};
